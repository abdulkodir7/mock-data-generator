<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Task 6</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>

<nav class="navbar navbar-light bg-light">
    <a class="navbar-brand" href="#" style="padding-left: 5rem">
        <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBw0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ8NDg0OFREWFhURExMYHiggGBomGxUTITEhJikuLi8uFx8zODcsNygtLisBCgoKDQ0NFw8PFSsdHx0rLS0tKy0tKystLisrLS0tLSsrLS0rKy0rLysrLSstLS0rLS0tLS0rLS0tLSstKy0tLf/AABEIAOEA4QMBEQACEQEDEQH/xAAcAAEBAAIDAQEAAAAAAAAAAAAAAQQHAgUGCAP/xABBEAEAAgEBAwQPBQYHAQAAAAAAAQIDBAURIQYxUXEHEhMWMkFUYXKBkZOhsdE0QnSSsyIzRFJiohRDY3OCwfEV/8QAHAEBAQEAAwEBAQAAAAAAAAAAAwEAAgUGBAgH/8QALxEBAQEAAQICCAQHAQAAAAAAAAECAwQREjEFExUhQVFScTNhobEiMkKBkcHwFP/aAAwDAQACEQMRAD8A6d/RXiIMSCFgxIISCFyNSwQsELBiwQsEJBCwQsGLBCwQsGLlELBC5VCxJYuRDZELBC5GNBCQQ0Gcldm/PMEJBiwYkEJBCwQsGLkQsELBiQQsELkQsGLEQsVCxGLBCwQsELBC5GNkQsELkQsELBiwZz7K7N+eIIWDEgxYITIhYIWDFghIIWDFghciFghYMWCFghIiFghoMXKoWIhciFyMWCGyIWCFyMaDOSuzfniCEgxYISDFyISCGyIWDEghYIWDEghciFghcjFghcohskISDGyIWCFghcjFghsiFghYMWDOauzfniCEgxYISDFghIIWCFgxYIWCEgxciFghYIWDFiShciFyIWDGyIWCFyIWDFyIaCFghYMWCOau0fneCFkGJBCwQkGLBC5ELBiwQsEJBCwYsELBCwQsRi5ELBCwQsGLkQ2RCwQsGLBCwQ0ELBnJXaPzxBCwYkEJBCwYsELBCwYkENBCQQsELBiwQsELEYuVhCxELBCwY2RCwQsELBiwQuRDQQkEc1dq/PEEJBCwYkELBqWCFghIMWDiWDFghcm9LYWP2waTNl/dYcuX/bx3yfKBa5uPP82pP7kljscPJbaWTwdFnj069z+Ftz5tdf00v83+3OcmfjWVTkTtWf4Xd15cUf8AbhfSfTfU5Tn458XLvF2r5PHvsX1cfanTfV+hJ1PH8zvF2r5PX32P6p7T6f6v0c51XF8zvF2r5PX32P6t7T6f6v0JOs4fmd421fJ499j+qe0un+r9CTruD5neLtXyevvsf1b2l03zc51/T/N5/NitS96Wjdal7UtHPutWZiY9sPtzqazNT4uxxqazLH5qbIhoIWDFyIWCFyqEHavzvBCQQkGLkQsEJBiwQsELIMWMzZey9TrL9z0+K2WY3dtMRurT0rTwh83P1PFwzvulj3OyOxtHC2szzPj7lg4R67zz+qHS8/prV93Fn/Ln3es2fyY2fpt3ctLi7aPv3jul/bbe6vl6zn5P5t1vFXbRSI4RERHmjc+e21O7kjCsMwzDMMyMzQO1/ter/Fan9Wz2HB+Fj7T9nsen/Cz9p+zEK+rIhYIWCFyMWCFyM5q7N+d4MWQQkGJBCwQsGLkQsE7lj2HJDkVfWRXUantsemndNKRwyZo6f6a+fx/F0vX+k5x98cXvvxvyPnLaOi0eLT464sNK48deatI3R1vN73revFq9yMhGGYZhmGYZhmGYZkZmgNrfatV+K1H6tnsOD8LP2n7PZdP+Fn7RilfTFQ0RCQQ2RiwQuRnNXZvzvBiQQsGJBCwQsGLBCx63kFyZjW5J1Geu/S4rborPNnyfy+jHDf17ul03pTrvVT1eL/Ff0j6OPPf3ttxERwiIiOiHmDq3ZhmSUtY3szG1G0dPi/eZ8NPTyUr85Jnj3fLNXw2/Bh35SbPrz63Te9rJJ0vPfLF/w5Ti3fg499GzfLdP7yHL/wAfUfRXL1HJ9J30bN8t0/vIT/x8/wBFX1HL9Lt975wqzJLM0BtX7VqvxOo/Us9hwfhZ+0ez6f8ADz9oxSPpyMWCFghoMSCGis5Ds354gxIISCFgxYIWCFjI2fo76jNiwY433y3rSvm3zzz5o5/ULn5pxcd3fgXM73s3tsvQY9LgxafFG6mKsVjzz47T55nfLw3Jy65dXd+NfbJ2jLcVRGYG19r6fRY+66jJFK81Y573norXnk3DwcnNrw4ndZO7X22OyPqMkzXR464Kc0ZMkRkyz593gx8XecHofEnfl13/ACLnj+byus2zrM8782qz33+Kclor+WODssdLw48sQ+cyfBgbjySGkENkY2XHJ4Nuqfk43yc5Pc+i6vEV56qyJLM+f9qfadT+Jz/qWew4fw8/aPZ9P+Hn7RjEfVkY0ELkQsEJBjRWUdm/PMGJBCQQsGJBC5ELHuOxXs6L6jNqrRwwUjHT0788+qsf3Oi9Nc3bGeOfH3vq4Z7+7aLzj6RmYO2do49Hp8uoy+Djrv3eO1uaKx55ncTh4dc3JMZ+LNI7Y2rm1ua2fPbfafBrHg46+KtY6HsOm6fHBiZybMYT6CxJbuXKuJYjFghY5Ysfb2rSPv2rT2zuHu9s2ufftK+h4eKedVmSWaPnzWW7bNmt/Nly29t5l7Hinbjz9o9rwe7jzPyj8XN9ORiwQuRDQQkGLFRR2j88wYkELBCwQkGLCULG3uxrpO5bNpfdxz5MmWerf2kfCse15D0ryeLqbPl7n3cU7ZerdcQZmt+yvtGZtp9HWeEb8+SPPxrSJ/u+DvfQvDO+uS/ZY189BTQQkELBC5RDRWLl2XJrT911+jx8+/UY5nqrPbT8Il8vWa8PBu/knNfDxav5N7vIOgGZ+GtyRTFlvPCKY72n1VmXLE76kcuOd9yPn2bb+PTxeyk7SR7bE7SQhj5RiwQuRCwQsELBmV2j89QQkGLBCQQuRiwlCxvXkxh7noNHXo0+KfXNYmfm8N1WvFz7v5vvzP4Y7QDkMzS3L3Ud02pqeik0xx5u1pG/4zL1vorPh6bN+bnHn33kgxYiFioWIhcqxY9t2Ldnd01WXVWj9jBTtKzu4Tkv0dVd/wCaHTel+aTE458XyddydsTPzbTefdUMzoOXOs7hs3VW8d6Rhr15JivymX19Dx+PnzP7vr6Hj8fUZjSj1Xwevz5CFyIaDFyIWCFyrERFV2j88wQkGLBC5ELBixLc09TjfIuX0Fs+na4MNf5cWOPZWHguS992/m++eTIcVGZoblHfttfrrT5XqY9UZbRHwh7Po526fH2n7Ocde+ksGLlELFQsRCxmbK2Zn1mauHBSbXtMb5+7SvjtafFD5+fnxw58Wq5b5M8c76br2BsjHodNTT4+Pa8b38d7zz2l5TqObXNyXddLy8l5N3VdmEab2Zrrsr7S+z6Os/6+T4xSJ/ul3Xoni9+uS/Z3foji9+uS/Zrt3T0GYMbIhYIXIxYIWKzmMw7N+e4ISDFghYIWDEyl+aeqXG+Ro+hdL+7x+hX5PA6/mr7/AIP1RklmaE27Mf43W8f4vVfq2e06Wz1GPtP2JmMHfHSfvCw7aOmPa3eFy548drcKVtaeitZtPwcLvM86SWTzdnouTW0NR+70mfd/NkpOGvtvu3vl5Ov4Meep+6+txPOvUbJ7G2W262szRjjx48P7Vp/5zwj2S67m9Lzy4p3+49dXP6Y97snZOn0ePuenxRjrwmZjfNrz02tPGXTcvNyct8W73fHvk1u97WeNwGZja7VY8GLJmyWiuPHW17TPiiHLGLvUznzrljF3qZnnWi9s7RvrNTm1F9+/JffWJ+7SOFa+qIh63g4c8XHMT/q9f03DnixMT/qwivryMXIhYIbIxIIbKo5DMO0fnyCEgxYIWCFyMWON+aeqXG+RMvofT+BT0K/J4HXnX3v0RhmYttn6eZmZwYZmZmZmcVJmZ6Znc5+s3P6q3dx/+ZpvJ8HuqfRvW7+qr3vzcq6DT15sGGOrHT6N6zfxtbvX71x1jmrEdURDhba3euUMiswzDM4Wndx9rfZmq+X/ACojVW/wmntv0+O2/JeObNePFH9MT7Zeg9HdF4J6zfn8Hfej+k8E9Zrz/wBPGO1d1BC5GLkQsENkYsELFRUZldo/PsEJBCwYmRCwQscb809UpfIuX0Np/Ap6Ffk8Drzr7n6owzDMMwzDMMwzDMxddrsOnpOTPkripXntad3/ALLlx8e93w5neueMa3e0ndrDldy2vq4tp9L22LTzwteeGTNHR/TXzc8u/wCj9HZ474uT339I7rpOhmP4t+f7PHO1dtmCFghsjFghciFghYsMWCKjMrtH59ghIIaCEgxciFjjfmnqlL5Fy+h8HgU9GvyeAvnX2uae9hvewrG9mJZhmfln1OPHG/JkpSOm9q1j4rM61fdFmbfKOl1/LPZuCJ36mMlo+7hicsz644fF9XH0HUb8smx03Lryjyu1eyVe0TXR4O03/wCZnmLWjqpHD4ux4fREnv5Nf2j7OLoPrrxW0do6jVX7pqMt8tvF208K+ateaPU7Xi4OPinhxns7Ph4s8c7ZjEK+mDFghYIbIxciFyIWCFghIrKMw7N+foMSCFghYMXIhYSlLHbxyn2lHCNbn3Rwj9qPo+G+j+m+iGmqvfTtLy3P+aPo3s7pvohJanfRtLy3P+aPons7pvohId9O0vLc/wCaPons7pvohJmL30bS8tz/AJo+jez+m+iEmM/Jwtym2jPPrdR6r7vks6Hp5/RCzjz8mPl2xrL+Fq9Tbrz5Pq5zpeGeWJ/gsxn5MPJebTvtM2nptM2n2ySYznynY2ZPk4qaDFysIaIhYMWCFyIXIhsjFyIWCFioQZhmHZvz9BiwQsELBCwYmRCwQsGLBCwQsELBi5EJEQ2VYsRC5WELEQ0VqWIhciGyISCGyMWCFyrOYjDMOzfn+DFghIIWCFgxciFghYMSEoaCFghYMSJKFyIaCFyMXKoWIhYMaCFyIWCFyIbIxYIWKjkMwzDs38AgxYISCFghYMWCFghZBiwQsEJBCwYsRC5ENFQuUYsELBC5ENBC5GLBCwQuRi5VCwRyGYZh2b+AwQkGLBCwQsGLBCwQsELBCQYsELEQsGLBDQQmVY0RCwQuRCwQ2RiwQmRDQQuRixUUZhmHZv4DBCwYsELBCwYsELBCwQsGJBCwQsELEYuRDQQmRDQQsGLkQsENkYsELkQsELFYkEUZhmHZv4FIIWDFghYIWCEgxYIWCFghYMWRELlULEQuRCwYuRCwQuRqaCFghcksXIhciGghIIVWYZhmHZP4HIMWCEgxYIWCFghYMWCFghYIWDEghZEQ2RiwQuVQ0RCZGpoITIhoShcjGghIIXKoQZhmGYdk/gkGJBC5GLBCwQmRC5GNBCQQsELBixJQuRCwhiwQuVQ0RC5GpoITKoaIhcjFghciFyqOYzDMMz//2Q=="
             width="40" class="d-inline-block align-top" alt="" style="border-radius: 100px">
        Itransition
    </a>
</nav>

<div class="container">
    <div class="card-body d-flex flex-column">
        <form th:action="@{/}" method="post">
            <div class="row form-group  align-items-end">
                <div class="col-md-2">
                    <select th:switch="${country}" class="custom-select" name="country" id="country">
                        <div th:case="'ru'">
                            <option>Select country</option>
                            <option selected value="ru">Russia</option>
                            <option value="en">USA</option>
                            <option value="it">Italy</option>
                        </div>
                        <div th:case="'en'">
                            <option>Select country</option>
                            <option value="ru">Russia</option>
                            <option selected value="en">USA</option>
                            <option value="it">Italy</option>
                        </div>
                        <div th:case="'it'">
                            <option>Select country</option>
                            <option value="ru">Russia</option>
                            <option value="en">USA</option>
                            <option selected value="it">Italy</option>
                        </div>
                        <div th:case="null">
                            <option selected>Select country</option>
                            <option value="ru">Russia</option>
                            <option value="en">USA</option>
                            <option value="it">Italy</option>
                        </div>
                    </select>
                </div>
                <div th:if="${users}!=null">
                    <input type="number" th:value="${#lists.size(users)}" hidden id="usersLength">
                </div>
                <div class="col-md-2">
                    <input type="range" class="custom-range" name="rangeInput" min="1" max="10" step="0.5"
                           onchange="updateTextInput(this.value);" id="range">
                </div>
                <div class="col-md-2">
                    <input id="errorPerRecord" placeholder="Error per record" type="text" class="form-control"
                           name="error" onchange="checkErrorValue(this.value)" th:value="${error}">
                </div>
                <div class="col-md-1">
                    <input type="text" class="form-control typeahead" id="seedValue" name="seed" placeholder="Seed"
                           data-provide="typeahead" th:value="${seed}" style="-webkit-appearance: none; margin: 0">
                </div>
                <div class="col-md-2">
                    <button type="button" class="mt-auto btn btn-primary" onclick="generateRandom()">
                        <i class="fa-solid fa-arrows-spin"></i> Seed
                    </button>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark">
                        <i class="fa-solid fa-shuffle"></i> Generate Data
                    </button>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-warning" id="download-button">
                        <i class="fa fa-download" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div class="div" style="overflow: auto; height: 350px">

        <table class="table" id="dataTable">
            <thead class="thead-light" style="position: sticky; top: 0;">
            <tr>
                <th scope="col">#</th>
                <th scope="col">Id</th>
                <th scope="col">Full Name</th>
                <th scope="col">Address</th>
                <th scope="col">Phone Number</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <tr th:each="user : ${users}">
                <th scope="row" th:text="${user.sequenceNumber}"></th>
                <td th:text="${user.id}"></td>
                <td th:text="${user.fullName}"></td>
                <td th:text="${user.fullAddress}"></td>
                <td th:text="${user.phoneNumber}"></td>
            </tr>
            </tbody>
        </table>
    </div>


</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function updateTextInput(val) {
        document.getElementById('errorPerRecord').value = val;
    }

    function generateRandom(maxLimit = 1000) {
        let rand = Math.random() * maxLimit;
        rand = Math.floor(rand);
        document.getElementById('seedValue').value = rand;
    }

    function checkErrorValue(errVal) {
        let rangeValue = document.getElementById('range').value;

        if (rangeValue < errVal)
            document.getElementById('range').value++;
    }

    jQuery(function ($) {
        $('.div').on('scroll', function () {
            if ($(this).scrollTop() +
                $(this).innerHeight() >=
                $(this)[0].scrollHeight) {
                load10data();
            }
        });
    });

    function load10data() {
        var countryVal = document.getElementById("country").value;
        var seedVal = document.getElementById("seedValue").value;
        var errorVal = document.getElementById("errorPerRecord").value;
        var usersLength = $('#dataTable tr').length;
        console.log(usersLength);

        console.log()

        fetch("/api/v1/generateData", {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                'country': countryVal,
                'error': errorVal,
                'seed': seedVal,
                'dataLength': usersLength
            })
        }).then(function (response) {
            if (response.ok) {
                response.json().then(res => {
                    res.map(user => {
                        appendUser(user, usersLength);
                    })
                })
            }
        });

    }

    function appendUser(user, length) {
        $("#tableBody").append(
            "<tr>" +
            "<th scope='row'>" + user.sequenceNumber + "</th>" +
            "<td>" + user.id + "</td>" +
            "<td>" + user.fullName + "</td>" +
            "<td>" + user.fullAddress + "</td>" +
            "<td>" + user.phoneNumber + "</td>" +
            "</tr>"
        )
        console.log(length);
        length = length + 10;
    }

    function htmlToCSV(html, filename) {
        var data = [];
        var rows = document.querySelectorAll("table tr");

        for (var i = 0; i < rows.length; i++) {
            var row = [], cols = rows[i].querySelectorAll("td, th");

            for (var j = 0; j < cols.length; j++) {
                row.push(cols[j].innerText);
            }

            data.push(row.join(","));
        }

        downloadCSVFile(data.join("\n"), filename);
    }

    function downloadCSVFile(csv, filename) {
        var csv_file, download_link;

        csv_file = new Blob([csv], {type: "text/csv"});

        download_link = document.createElement("a");

        download_link.download = filename;

        download_link.href = window.URL.createObjectURL(csv_file);

        download_link.style.display = "none";

        document.body.appendChild(download_link);

        download_link.click();
    }

    document.getElementById("download-button").addEventListener("click", function () {
        var html = document.querySelector("table").outerHTML;
        htmlToCSV(html, "students.csv");
    });

    // function createExportHeader(dataSource, separator) {
    //     var headerRow = "",
    //         columns = dataSource.columns,
    //         newLine = "\r\n";
    //
    //     for (var i=0; i < columns.length; i++) {
    //         headerRow += (i > 0 ? separator : '') + columns[i].displayName;
    //     }
    //     return headerRow + newLine;
    // }
    //
    // function createExportRows(dataSource, separator) {
    //     var content = "",
    //         columns = dataSource.columns,
    //         data = dataSource.data,
    //         newLine = "\r\n",
    //         dataField;
    //
    //     for(var j=0; j < data.length; j++) {
    //         for (var i=0; i < columns.length; i++) {
    //             dataField = columns[i].dataField;
    //             content += (i > 0 ? separator : '') + data[j][dataField];
    //         }
    //         content += newLine;
    //     }
    //     return content;
    // }
    //
    // function excelExport() {
    //     var separator = ',',
    //         dataSource = {
    //             data: [
    //                 {
    //                     name: "Frank Über",
    //                     age: 49
    //                 },
    //                 {
    //                     name: "Toni Köhl",
    //                     age: 56
    //                 }
    //             ],
    //             columns: [
    //                 {
    //                     dataField: "name",
    //                     displayName: "Name"
    //                 },
    //                 {
    //                     dataField: "age",
    //                     displayName: "Alter"
    //                 }
    //             ]
    //         };
    //     var content = createExportHeader(dataSource, separator);
    //     content += createExportRows(dataSource, separator);
    //
    //     //an anchor html element on the page (or create dynamically one)
    //     //to use its download attribute to set filename
    //     var a = document.getElementById('csv');
    //     a.textContent='download';
    //     a.download="MyFile.csv";
    //     a.href='data:text/csv;charset=utf-8,%EF%BB%BF'+encodeURIComponent(content);
    //     a.click();
    // }

</script>
</body>
</html>